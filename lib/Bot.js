"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Bot {
    constructor(config, client, 
    // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types
    context, // eslint-disable-line @typescript-eslint/no-explicit-any
    services = []) {
        this.mods = [];
        this.vips = [];
        // Save references
        this.config = config;
        this.context = context;
        this.services = services;
        // Setup services
        services.forEach((service) => {
            service.bot = this;
        });
        this.chatClient = client;
        //#region setup chatClient hooks
        this.chatClient.on('message', this.onMessage.bind(this));
        this.chatClient.on('connected', this.onConnected.bind(this));
        this.chatClient.on('join', this.onJoin.bind(this));
        this.chatClient.on('part', this.onPart.bind(this));
        // Monetization
        this.chatClient.on('anongiftpaidupgrade', (channel, username, userstate) => {
            this.onMonetization(channel, userstate, '', { type: 'anongiftpaidupgrade' });
        });
        this.chatClient.on('cheer', (channel, userstate, message) => {
            this.onMonetization(channel, userstate, message, { type: 'cheer' });
        });
        this.chatClient.on('giftpaidupgrade', (channel, username, sender, userstate) => {
            this.onMonetization(channel, userstate, '', { type: 'giftpaidupgrade', sender });
        });
        this.chatClient.on('resub', (channel, username, months, message, userstate, methods) => {
            this.onMonetization(channel, userstate, message, { type: 'resub', months, methods });
        });
        this.chatClient.on('subgift', (channel, username, streakMonths, recipient, methods, userstate) => {
            this.onMonetization(channel, userstate, '', { type: 'subgift', streakMonths, recipient, methods });
        });
        this.chatClient.on('submysterygift', (channel, username, numbOfSubs, methods, userstate) => {
            this.onMonetization(channel, userstate, '', { type: 'submysterygift', numbOfSubs, methods });
        });
        this.chatClient.on('subscription', (channel, username, method, message, userstate) => {
            this.onMonetization(channel, userstate, message, { type: 'subscription', method });
        });
        //#endregion
        // Connect to chat!
        this.chatClient.connect();
    }
    onConnected( /* addr: string, port: number */) {
        if (!this.config.silent && this.config.connectedMessage)
            this.sendChatMessage(this.config.connectedMessage);
        this.services.forEach((service) => {
            service.onConnected();
        });
        // Get mod and VIP lists
        this.chatClient.mods(this.config.channel).then(data => this.mods = data);
        this.chatClient.vips(this.config.channel).then(data => this.vips = data);
    }
    onMessage(channel, userstate, msg, self) {
        if (this.config.banList.includes(userstate["display-name"]))
            return;
        // TODO logging;
        // console.log('onMessage', channel, userstate["display-name"], msg);
        this.services.forEach((service) => {
            service.onMessage(channel, userstate, msg, self);
        });
    }
    onMonetization(channel, userstate, msg, monetization) {
        this.services.forEach((service) => {
            service.onMonetization(channel, userstate, msg, monetization);
        });
    }
    onJoin(channel, username, self) {
        this.services.forEach((service) => {
            service.onJoin(channel, username, self);
        });
    }
    onPart(channel, username, self) {
        this.services.forEach((service) => {
            service.onPart(channel, username, self);
        });
    }
    sendChatMessage(message) {
        if (!this.config.silent)
            this.chatClient.say(this.config.channel, message);
    }
}
exports.default = Bot;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm90LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0JvdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWtDQSxNQUFxQixHQUFHO0lBQ3RCLFlBQ0UsTUFBaUIsRUFDakIsTUFBa0I7SUFDbEIsNkVBQTZFO0lBQzdFLE9BQVksRUFBRSx5REFBeUQ7SUFDdkUsV0FBc0IsRUFBRTtRQXFEMUIsU0FBSSxHQUFhLEVBQUUsQ0FBQztRQUNwQixTQUFJLEdBQWEsRUFBRSxDQUFDO1FBcERsQixrQkFBa0I7UUFDbEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFFekIsaUJBQWlCO1FBQ2pCLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUMzQixPQUFPLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO1FBQ3pCLGdDQUFnQztRQUNoQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMs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QUNoQyxPQUFPLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ2hFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUFlLEVBQUUsUUFBZ0IsRUFBRSxJQUFhO1FBQ3JELElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDaEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUFlLEVBQUUsUUFBZ0IsRUFBRSxJQUFhO1FBQ3JELElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDaEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWUsQ0FBQyxPQUFlO1FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU07WUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM3RSxDQUFDO0NBQ0Y7QUF0R0Qsc0JBc0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNlcnZpY2UgZnJvbSAnLi9TZXJ2aWNlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQm90Q29uZmlnIHtcbiAgY2hhbm5lbDogc3RyaW5nO1xuICBiYW5MaXN0OiBzdHJpbmdbXTtcbiAgc2lsZW50OiBib29sZWFuO1xuICBjb25uZWN0ZWRNZXNzYWdlPzogc3RyaW5nO1xufVxuXG50eXBlIHRtaUV2ZW50ID0gJ21lc3NhZ2UnXG4gIHwgJ2Nvbm5lY3RlZCdcbiAgfCAnYW5vbmdpZnRwYWlkdXBncmFkZSdcbiAgfCAnY2hlZXInXG4gIHwgJ2dpZnRwYWlkdXBncmFkZSdcbiAgfCAncmVzdWInXG4gIHwgJ3N1YmdpZnQnXG4gIHwgJ3N1Ym15c3RlcnlnaWZ0J1xuICB8ICdzdWJzY3JpcHRpb24nXG4gIHwgJ2pvaW4nXG4gIHwgJ3BhcnQnO1xuXG5pbXBvcnQgeyBDb21tb25Vc2Vyc3RhdGUgfSBmcm9tICd0bWkuanMnXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2hhdENsaWVudCB7XG4gIG9uOiAoZXZlbnQ6IHRtaUV2ZW50LCBjYWxsYmFjazogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkO1xuICBjb25uZWN0OiAoKSA9PiB2b2lkO1xuICBzYXk6IChjaGFubmVsOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZykgPT4gdm9pZDtcbiAgbW9kczogKGNoYW5uZWw6IHN0cmluZykgPT4gUHJvbWlzZTxzdHJpbmdbXT47XG4gIHZpcHM6IChjaGFubmVsOiBzdHJpbmcpID0+IFByb21pc2U8c3RyaW5nW10+O1xufVxuXG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlclN0YXRlIGV4dGVuZHMgQ29tbW9uVXNlcnN0YXRlIHsgfSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1pbnRlcmZhY2VcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQm90IHtcbiAgY29uc3RydWN0b3IoXG4gICAgY29uZmlnOiBCb3RDb25maWcsXG4gICAgY2xpZW50OiBDaGF0Q2xpZW50LFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvZXhwbGljaXQtbW9kdWxlLWJvdW5kYXJ5LXR5cGVzXG4gICAgY29udGV4dDogYW55LCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICBzZXJ2aWNlczogU2VydmljZVtdID0gW11cbiAgKSB7XG4gICAgLy8gU2F2ZSByZWZlcmVuY2VzXG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcbiAgICB0aGlzLnNlcnZpY2VzID0gc2VydmljZXM7XG5cbiAgICAvLyBTZXR1cCBzZXJ2aWNlc1xuICAgIHNlcnZpY2VzLmZvckVhY2goKHNlcnZpY2UpID0+IHtcbiAgICAgIHNlcnZpY2UuYm90ID0gdGhpcztcbiAgICB9KTtcblxuICAgIHRoaXMuY2hhdENsaWVudCA9IGNsaWVudDtcbiAgICAvLyNyZWdpb24gc2V0dXAgY2hhdENsaWVudCBob29rc1xuICAgIHRoaXMuY2hhdENsaWVudC5vbignbWVzc2FnZScsIHRoaXMub25NZXNzYWdlLmJpbmQodGhpcykpO1xuICAgIHRoaXMuY2hhdENsaWVudC5vbignY29ubmVjdGVkJywgdGhpcy5vbkNvbm5lY3RlZC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmNoYXRDbGllbnQub24oJ2pvaW4nLCB0aGlzLm9uSm9pbi5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmNoYXRDbGllbnQub24oJ3BhcnQnLCB0aGlzLm9uUGFydC5iaW5kKHRoaXMpKTtcblxuICAgIC8vIE1vbmV0aXphdGlvblxuICAgIHRoaXMuY2hhdENsaWVudC5vbignYW5vbmdpZnRwYWlkdXBncmFkZScsIChjaGFubmVsOiBzdHJpbmcsIHVzZXJuYW1lOiBzdHJpbmcsIHVzZXJzdGF0ZTogVXNlclN0YXRlKSA9PiB7XG4gICAgICB0aGlzLm9uTW9uZXRpemF0aW9uKGNoYW5uZWwsIHVzZXJzdGF0ZSwgJycsIHsgdHlwZTogJ2Fub25naWZ0cGFpZHVwZ3JhZGUnIH0pO1xuICAgIH0pO1xuICAgIHRoaXMuY2hhdENsaWVudC5vbignY2hlZXInLCAoY2hhbm5lbDogc3RyaW5nLCB1c2Vyc3RhdGU6IFVzZXJTdGF0ZSwgbWVzc2FnZSkgPT4ge1xuICAgICAgdGhpcy5vbk1vbmV0aXphdGlvbihjaGFubmVsLCB1c2Vyc3RhdGUsIG1lc3NhZ2UsIHsgdHlwZTogJ2NoZWVyJyB9KTtcbiAgICB9KTtcbiAgICB0aGlzLmNoYXRDbGllbnQub24oJ2dpZnRwYWlkdXBncmFkZScsIChjaGFubmVsOiBzdHJpbmcsIHVzZXJuYW1lOiBzdHJpbmcsIHNlbmRlcjogc3RyaW5nLCB1c2Vyc3RhdGU6IFVzZXJTdGF0ZSkgPT4ge1xuICAgICAgdGhpcy5vbk1vbmV0aXphdGlvbihjaGFubmVsLCB1c2Vyc3RhdGUsICcnLCB7IHR5cGU6ICdnaWZ0cGFpZHVwZ3JhZGUnLCBzZW5kZXIgfSk7XG4gICAgfSk7XG4gICAgdGhpcy5jaGF0Q2xpZW50Lm9uKCdyZXN1YicsIChjaGFubmVsOiBzdHJpbmcsIHVzZXJuYW1lOiBzdHJpbmcsIG1vbnRoczogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcsIHVzZXJzdGF0ZTogVXNlclN0YXRlLCBtZXRob2RzOiBhbnkpID0+IHtcbiAgICAgIHRoaXMub25Nb25ldGl6YXRpb24oY2hhbm5lbCwgdXNlcnN0YXRlLCBtZXNzYWdlLCB7IHR5cGU6ICdyZXN1YicsIG1vbnRocywgbWV0aG9kcyB9KTtcbiAgICB9KTtcbiAgICB0aGlzLmNoYXRDbGllbnQub24oJ3N1YmdpZnQnLCAoY2hhbm5lbDogc3RyaW5nLCB1c2VybmFtZTogc3RyaW5nLCBzdHJlYWtNb250aHM6IG51bWJlciwgcmVjaXBpZW50OiBzdHJpbmcsIG1ldGhvZHM6IGFueSwgdXNlcnN0YXRlOiBVc2VyU3RhdGUpID0+IHtcbiAgICAgIHRoaXMub25Nb25ldGl6YXRpb24oY2hhbm5lbCwgdXNlcnN0YXRlLCAnJywgeyB0eXBlOiAnc3ViZ2lmdCcsIHN0cmVha01vbnRocywgcmVjaXBpZW50LCBtZXRob2RzIH0pO1xuICAgIH0pO1xuICAgIHRoaXMuY2hhdENsaWVudC5vbignc3VibXlzdGVyeWdpZnQnLCAoY2hhbm5lbDogc3RyaW5nLCB1c2VybmFtZTogc3RyaW5nLCBudW1iT2ZTdWJzOiBudW1iZXIsIG1ldGhvZHM6IGFueSwgdXNlcnN0YXRlOiBVc2VyU3RhdGUpID0+IHtcbiAgICAgIHRoaXMub25Nb25ldGl6YXRpb24oY2hhbm5lbCwgdXNlcnN0YXRlLCAnJywgeyB0eXBlOiAnc3VibXlzdGVyeWdpZnQnLCBudW1iT2ZTdWJzLCBtZXRob2RzIH0pO1xuICAgIH0pO1xuICAgIHRoaXMuY2hhdENsaWVudC5vbignc3Vic2NyaXB0aW9uJywgKGNoYW5uZWwsIHVzZXJuYW1lLCBtZXRob2QsIG1lc3NhZ2UsIHVzZXJzdGF0ZSkgPT4ge1xuICAgICAgdGhpcy5vbk1vbmV0aXphdGlvbihjaGFubmVsLCB1c2Vyc3RhdGUsIG1lc3NhZ2UsIHsgdHlwZTogJ3N1YnNjcmlwdGlvbicsIG1ldGhvZCB9KVxuICAgIH0pO1xuICAgIC8vI2VuZHJlZ2lvblxuXG4gICAgLy8gQ29ubmVjdCB0byBjaGF0IVxuICAgIHRoaXMuY2hhdENsaWVudC5jb25uZWN0KCk7XG4gIH1cblxuICBjb25maWc6IEJvdENvbmZpZztcbiAgLy8gY29udGV4dCBpcyBhbiBlc2NhcGUgaGF0Y2ggZm9yIHRoZSBzZXJ2aWNlIHRvIGFjY2VzcyBpdHMgcGFyZW50IGRyaXZlciBhcHAsIG5lZWRzIHRvIGJlIGFueVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2V4cGxpY2l0LW1vZHVsZS1ib3VuZGFyeS10eXBlc1xuICBjb250ZXh0OiBhbnk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBjaGF0Q2xpZW50OiBDaGF0Q2xpZW50O1xuICBwcml2YXRlIHNlcnZpY2VzOiBTZXJ2aWNlW107XG4gIG1vZHM6IHN0cmluZ1tdID0gW107XG4gIHZpcHM6IHN0cmluZ1tdID0gW107XG5cbiAgb25Db25uZWN0ZWQoLyogYWRkcjogc3RyaW5nLCBwb3J0OiBudW1iZXIgKi8pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLnNpbGVudCAmJiB0aGlzLmNvbmZpZy5jb25uZWN0ZWRNZXNzYWdlKSB0aGlzLnNlbmRDaGF0TWVzc2FnZSh0aGlzLmNvbmZpZy5jb25uZWN0ZWRNZXNzYWdlKTtcbiAgICB0aGlzLnNlcnZpY2VzLmZvckVhY2goKHNlcnZpY2UpID0+IHtcbiAgICAgIHNlcnZpY2Uub25Db25uZWN0ZWQoKTtcbiAgICB9KTtcbiAgICAvLyBHZXQgbW9kIGFuZCBWSVAgbGlzdHNcbiAgICB0aGlzLmNoYXRDbGllbnQubW9kcyh0aGlzLmNvbmZpZy5jaGFubmVsKS50aGVuKGRhdGEgPT4gdGhpcy5tb2RzID0gZGF0YSk7XG4gICAgdGhpcy5jaGF0Q2xpZW50LnZpcHModGhpcy5jb25maWcuY2hhbm5lbCkudGhlbihkYXRhID0+IHRoaXMudmlwcyA9IGRhdGEpO1xuICB9XG5cbiAgb25NZXNzYWdlKGNoYW5uZWw6IHN0cmluZywgdXNlcnN0YXRlOiBVc2VyU3RhdGUsIG1zZzogc3RyaW5nLCBzZWxmOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmJhbkxpc3QuaW5jbHVkZXModXNlcnN0YXRlW1wiZGlzcGxheS1uYW1lXCJdKSkgcmV0dXJuO1xuICAgIC8vIFRPRE8gbG9nZ2luZztcbiAgICAvLyBjb25zb2xlLmxvZygnb25NZXNzYWdlJywgY2hhbm5lbCwgdXNlcnN0YXRlW1wiZGlzcGxheS1uYW1lXCJdLCBtc2cpO1xuICAgIHRoaXMuc2VydmljZXMuZm9yRWFjaCgoc2VydmljZSkgPT4ge1xuICAgICAgc2VydmljZS5vbk1lc3NhZ2UoY2hhbm5lbCwgdXNlcnN0YXRlLCBtc2csIHNlbGYpO1xuICAgIH0pO1xuICB9XG5cbiAgb25Nb25ldGl6YXRpb24oY2hhbm5lbDogc3RyaW5nLCB1c2Vyc3RhdGU6IFVzZXJTdGF0ZSwgbXNnOiBzdHJpbmcsIG1vbmV0aXphdGlvbjogYW55KTogdm9pZCB7XG4gICAgdGhpcy5zZXJ2aWNlcy5mb3JFYWNoKChzZXJ2aWNlKSA9PiB7XG4gICAgICBzZXJ2aWNlLm9uTW9uZXRpemF0aW9uKGNoYW5uZWwsIHVzZXJzdGF0ZSwgbXNnLCBtb25ldGl6YXRpb24pO1xuICAgIH0pO1xuICB9XG5cbiAgb25Kb2luKGNoYW5uZWw6IHN0cmluZywgdXNlcm5hbWU6IHN0cmluZywgc2VsZjogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuc2VydmljZXMuZm9yRWFjaCgoc2VydmljZSkgPT4ge1xuICAgICAgc2VydmljZS5vbkpvaW4oY2hhbm5lbCwgdXNlcm5hbWUsIHNlbGYpO1xuICAgIH0pO1xuICB9XG5cbiAgb25QYXJ0KGNoYW5uZWw6IHN0cmluZywgdXNlcm5hbWU6IHN0cmluZywgc2VsZjogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuc2VydmljZXMuZm9yRWFjaCgoc2VydmljZSkgPT4ge1xuICAgICAgc2VydmljZS5vblBhcnQoY2hhbm5lbCwgdXNlcm5hbWUsIHNlbGYpO1xuICAgIH0pO1xuICB9XG5cbiAgc2VuZENoYXRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghdGhpcy5jb25maWcuc2lsZW50KSB0aGlzLmNoYXRDbGllbnQuc2F5KHRoaXMuY29uZmlnLmNoYW5uZWwsIG1lc3NhZ2UpO1xuICB9XG59XG4iXX0=